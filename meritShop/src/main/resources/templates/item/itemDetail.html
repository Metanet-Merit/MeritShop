<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{layout/mainPageLayout}">

<div layout:fragment="content">

<!-- 사용자 스크립트 추가 -->
    <style>

       .contents{
            display: flex;
        }
        .mgb-15{
            margin-bottom:15px;
        }
        .mgt-30{
            margin-top:30px;
        }
        .mgt-50{
            margin-top:50px;
        }
        .repImgDiv{
            margin-right:15px;
            height:auto;
            width:50%;
        }
        .repImg{
            width:100%;
            height:500px;
        }
        .wd50{
            height:auto;
            width:50%;
        }
        .delivery_info{
            padding-top: 10px;
            padding-bottom: 13px;
        }
    </style>
    <link rel="stylesheet" href="/css/item.css" type="text/css">
<div id="wrap" class="container-fluid ">


    <div id="container" style="margin-left:0%;margin-right:10%">
        <div class="location"><a href="#">Home</a> &gt; <a href="#">대분류</a> &gt;<a href="#">소분류</a> &gt; <a href="#"><span class="txt_w">상품 관리</span></a></div>
        <div class="contents">
            <div class="repImgDiv">
                <img th:src="${itemImgDto[0].imgUrl}" class = "img-fluid rounded repImg" >
            </div>

            <div class="wd50">
                <form action="/pay" id="frm">
                    <input type="hidden" id="itemId" name="orderItemDtoList[0].itemId" th:value="${itemFormDto.itemId}">

                    <span th:if="${itemFormDto.status == T(com.merit.meritShop.item.domain.ItemSellStatus).SELL}" class="badge badge-primary mgb-15">
                    판매중
                </span>
                    <span th:if="${itemFormDto.status == T(com.merit.meritShop.item.domain.ItemSellStatus).LACK}" class="badge badge-danger mgb-15">
                    품절 임박
                </span>
                <span th:if="${itemFormDto.status == T(com.merit.meritShop.item.domain.ItemSellStatus).SOLD_OUT}" class="badge btn-danger mgb-15" >
                    품절
                </span>
                <div id="itemName" class="h4" th:text="${itemFormDto.name}"></div>
                <hr class="my-4">

                <div class="text-right">
                    <div class="h4 text-danger text-left">
                        <span id="itemPrice" th:text="${itemFormDto.price}">10000</span>원
                    </div>
                    <div class="delivery_info"><strong>배송비 3,000원</strong><span class="text_info">(50,000원 이상 무료)</span></div>
                    <div class="input-group w-50">
                        <div class="input-group-prepend">
                            <span class="input-group-text">수량</span>
                        </div>
                        <input type="number" name="orderItemDtoList[0].count" id="count" class="form-control" value="1" min="1">
                    </div>
                </div>
                <hr class="my-4">
                <div id="rate" class="rating" data-size="lg"  > 평점: 5.0 </div>
                <hr class="my-4">
                <div id="options">
                    option<br>
                    <select id="itemOptionId" name="orderItemDtoList[0].itemOptionId" style="width:180px;">
                        <option>Select option</option>
                        <option th:each="option:${itemFormDto.options}" th:if="${option?.quantity>0}"
                                    th:value="${option?.itemOptionId}"
                                    th:utext="${option?.optionName}"></option>
                    </select>
                </div>
                <hr class="my-4">
                <div class="text-right mgt-50">
                    <h5>결제 금액</h5>
                    <h3 name="totalPrice" id="totalPrice" class="font-weight-bold"></h3>
                </div>
                <div th:if="${itemFormDto.status != T(com.merit.meritShop.item.domain.ItemSellStatus).SOLD_OUT}" class="text-right">
                    <button type="button" class="btn btn-light border border-primary btn-lg" onclick="cart()">장바구니 담기</button>
                    <button type="button" class="btn btn-primary btn-lg"  id="order_btn">주문하기</button>
                </div>
                <div th:if="${itemFormDto.status == T(com.merit.meritShop.item.domain.ItemSellStatus).SOLD_OUT}" class="text-right">
                    <button type="button" class="btn btn-danger btn-lg">품절</button>
                </div>

                </form>
            </div>

        </div>
        <div class="tabList">
            <ul class="prd_detail_tab" id="tabList">
                <li class="on" id="productInfo">
                    <a href="#tab1" class="goods" data-tap="tab-1">상품설명
                    </a>
                </li>
                <li id="reviewInfo">
                    <a href="#tab2" class="goods" data-tap="tab-2">리뷰
                        <span th:text="${result['rtnObj']['count']}">(843)</span>
                    </a>
                </li>
                <li id="qnaInfo">
                    <a href="#tab3" class="goods" data-tap="tab-3">Q&amp;A
                        <span th:text="${qnaResult['rtnObj']['count']}">(19)</span>
                    </a>
                </li>
            </ul>
            <div class="prd_detail_cont" id="tabContent">
                <div>
                    <div class="jumbotron jumbotron-fluid mgt-30">
                        <div class="Description">
                            <h4 class="display-5">상품 상세 설명</h4>
                            <p class="lead" th:text="${itemFormDto.description}"></p>
                        </div>

                    </div>
                    <div th:each="itemImg : ${itemImgDto}" class="text-center">
                        <img th:if="${not #strings.isEmpty(itemImg.imgUrl)}" th:src="${itemImg.imgUrl}" class="rounded mgb-15" width="800">

                    </div>
                </div>
                <div style="display: none">

                    <ul class="prd_qna_list" id="prd_qna_list" th:each="reviews:${result['rtnObj']['reviews']}">
                        <li>
                            <span th:text="'리뷰 작성 날짜:  '+ ${#temporals.format(reviews['reviewDate'],'yyyy-MM-dd')}">리뷰 작성 날짜</span>
                            <input type="hidden" th:value="${reviews['content']}"><button type="button" class="btn-review--small" data-toggle="modal" data-target="#myModal" onclick="changeModalContent(this)">리뷰보기</button><br></td></tr>
                        </li>
                    </ul>


                </div>
                <div style="display: none">
                    <div class="prd_qna_tit" th:href="'/user/qnaWrite/'+${itemFormDto.itemId}">
                        <button class="btnInquiry goods_qna_inquiry" th:href="'/user/qnaWrite/'+${itemFormDto.itemId}">
                            <a th:href="'/user/qnaWrite/'+${itemFormDto.itemId}">상품문의</a>
                        </button>
                    </div>
                    <ul class="prd_qna_list" id="prd_qna_list" th:each="qna:${qnaResult['rtnObj']['qnas']}">
                        <li>
                            <span th:text="'리뷰 작성 날짜:  '+ ${#temporals.format(qna['registerDate'],'yyyy-MM-dd')}">문의사항 작성 날짜</span>
                             <span th:if="${qna['replied']} == true">
                                 <input type="hidden" th:value="${qna['reply']}"><button type="button" class="btn-review--small" data-toggle="modal" data-target="#myModal" onclick="changeModalContent(this)">답변보기</button><br></td></tr>
                             </span>
                        </li>

                    </ul>
                </div>
            </div>
        </div>
</div>
</div>
<script>
    window.onload = function() {
        document.getElementById('order_btn').onclick = function() {
            document.getElementById('frm').submit();
            return false;
        };
    };

    function changeModalContent(e){
        $(".modal-body").text(e.previousSibling.value);
    }

    const getCookieValue = (key) => {
        let cookieKey = key + "=";
        let result = "";
        const cookieArr = document.cookie.split(";");

        for(let i = 0; i < cookieArr.length; i++) {
            if(cookieArr[i][0] === " ") {
                cookieArr[i] = cookieArr[i].substring(1);
            }

            if(cookieArr[i].indexOf(cookieKey) === 0) {
                result = cookieArr[i].slice(cookieKey.length, cookieArr[i].length);
                return result;
            }
        }
        return result;
    }
    function cart(){
        var url = "/cart";
        var paramData = {
            itemId : $("#itemId").val(),
            itemOptionId : $("#itemOptionId").val(),
            count : $("#count").val()

        };
        console.log(paramData)
        var param = JSON.stringify(paramData);

        $.ajax({
            url      : url,
            type     : "POST",
            contentType : "application/json",
            data     : param,
            dataType : "json",
            cache   : false,

            success  : function(result, status){

                console.log(result);
                alert("장바구니 추가!!");
                location.href='/cart';
            },
            error : function(jqXHR, status, error){

                if(jqXHR.status == '401'){
                    alert('로그인 후 이용해주세요');
                    location.href='/user/login';
                } else{
                    //alert(jqXHR.responseText);
                    console.log("현재는 이것만 뜬다네 ㅎㅎ");
                }

            }
        });
    }

</script>
<script>
    const tabMenu = document.querySelectorAll('#tabList>li');

    const tabContent = document.querySelectorAll('#tabContent>div');

    tabMenu.forEach(function (item, idx) {
        item.addEventListener('click', function (e) {
            e.preventDefault();
            showContent(idx);
            for(var i=0; i<3; i++) {
                tabMenu[i].classList.remove("on");
            }
            tabMenu[idx].classList.add("on");
        });

    });
    function showContent(num) {
        tabContent.forEach(function (item) {
            item.style.display = 'none';

        });
        tabContent[num].style = 'block';

    };


</script>

    <div class="container">

        <!-- Modal -->
        <div class="modal fade" id="myModal" role="dialog">
            <div class="modal-dialog">

                <!-- Modal content-->
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal">&times;</button>
                        <h4 class="modal-title"></h4>
                    </div>
                    <div class="modal-body">
                        <p>Some text in the modal.</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>

    </div>

</div>